---
lab:
    title: '15 - Azure Sentinel'
    module: '모듈 04 - 보안 작업 관리'
---

# 랩 15: Azure Sentinel
# 학생 랩 매뉴얼

## 랩 시나리오

Azure Sentinel 기반 위협 탐지 및 응답의 개념 증명을 만들라는 메시지가 표시됩니다. 특히 다음을 수행해야 합니다.

- Azure 활동 및 Security Center에서 데이터 수집을 시작합니다.
- 기본 제공 및 사용자 지정 경고 추가 
- 플레이북을 사용하여 인시던트에 대한 응답을 자동화하는 방법을 검토합니다.

> 이 랩에 있는 모든 리소스의 경우 **미국 동부** 지역을 사용합니다. 강사에게 이 지역이 수업에 사용할 지역인지 확인합니다. 

## 랩 목표

이 랩에서는 다음과 같은 연습을 완료합니다:

- 연습 1: Azure Sentinel 구현

## 랩 파일:

- **\\Allfiles\\Labs\\15\\changeincidentseverity.json**

### 연습 1: Azure Sentinel 구현

### 예상 시간: 30분

이 연습에서는 다음 작업을 수행합니다.

- 작업 1: Azure Sentinel 등록
- 작업 2: Azure 활동을 Sentinel에 연결
- 작업 3: Azure 활동 데이터 커넥터를 사용하는 규칙 만들기 
- 작업 4: 플레이북 만들기
- 작업 5: 사용자 지정 경고를 만들고 플레이북을 자동 응답으로 구성
- 작업 6: 인시던트를 호출하고 관련 작업을 검토합니다.

#### 작업 1: Azure Sentinel 등록

이 작업에서는 Azure Sentinel을 온보딩하고 Log Analytics 작업 영역을 연결합니다. 

1. Azure Portal **`https://portal.azure.com/`** 에 로그인합니다.

    >**참고**: 이 랩에 사용 중인 Azure 구독에 Owner 또는 Contributor 역할이 있는 계정을 사용하여 Azure Portal에 로그인합니다.

1. Azure Portal에서 페이지 상단에 있는 **리소스, 서비스 및 문서 검색** 텍스트 상자에 **Azure Sentinel**을 입력하고 **Enter** 키를 누릅니다.

1. **Azure Sentinel** 블레이드에서 **+ 새로 만들기**를 클릭합니다.

1. **작업 영역에 Azure Sentinel 추가** 블레이드에서, Azure Monitor 랩에서 만든 Log Analytics 작업 영역을 선택하고 **추가**를 클릭합니다.

    >**참고**: Azure Sentinel에는 작업 영역에 대한 매우 구체적인 요구 사항이 있습니다. 예를 들어 Azure Security Center에 의해 만들어진 작업 영역은 사용할 수 없습니다. [빠른 시작](https://docs.microsoft.com/ko-kr/azure/sentinel/quickstart-onboard)에서 더 알아보기[ Azure Sentinel 등록](https://docs.microsoft.com/ko-kr/azure/sentinel/quickstart-onboard)
	
#### 작업 2: Azure Sentinel을 구성하여 Azure 활동 데이터 커넥터를 사용합니다. 

이 작업에서는 Sentinel을 구성하여 Azure 활동 데이터 커넥터를 사용합니다.  

1. Azure Portal의 **Azure Sentinel \| 개요** 블레이드 **구성** 섹션에서 **데이터 커넥터**를 클릭합니다. 

1. **Azure Sentinel \| 데이터 커넥터** 블레이드에서 사용 가능한 커넥터 목록을 검토합니다. 그런 다음 필요하면 오른쪽으로 스크롤하여 **Azure 활동** 커넥터를 나타내는 항목을 클릭하고 설명을 검토한 후에 **커넥터 페이지 열기**를 클릭합니다.

1. **Azure 활동** 블레이드에서 **Azure 활동 로그 구성** 링크를 클릭합니다.

1. **Azure 활동 로그** 블레이드에서 이 랩에서 사용하는 Azure 구독을 나타내는 항목을 클릭한 다음 **연결**을 클릭합니다.

1. **Azure Sentinel \| 데이터 커넥터** 블레이드로 다시 이동하여 **새로 고침**을 클릭합니다.

1. **Azure Sentinel \| 데이터 커넥터** 블레이드에서 **Azure 활동**을 클릭합니다. 

1. **Azure 활동** 창에 **데이터 수신됨** 그래프가 표시되는지 확인합니다. 브라우저 창을 새로 고쳐야 할 수도 있습니다. 

    >**참고**: Azure 활동 로그에 포함된 모든 이벤트가 그래프에 반영되려면 5분 이상 걸릴 수도 있습니다.

#### 작업 3: Azure 활동 데이터 커넥터를 사용하는 규칙 만들기 

이 작업에서는 Azure 활동 데이터 커넥터를 사용하는 규칙을 검토하고 만듭니다. 

1. **Azure Sentinel \| 구성** 블레이드에서 **분석**을 클릭합니다. 

1. **Azure Sentinel \| 분석** 블레이드에서 **규칙 템플릿** 탭을 클릭합니다. 

    >**참고**: 만들 수 있는 규칙 유형을 검토합니다. 각 규칙은 특정 데이터 원본과 연결됩니다.

1. 규칙 템플릿 목록에서 검색 창 양식에 **의심스러움**을 입력한 후 **Azure 활동** 데이터 원본과 연결된 **의심스러운 리소스 작성 또는 배포 수** 항목을 클릭합니다. 그런 다음 규칙 템플릿 속성이 표시된 창에서 필요하면 페이지 오른쪽으로 스크롤하여 **규칙 만들기**를 클릭합니다.

    >**참고**: 이 규칙은 중간 심각도를 가지고 있습니다. 

1. **분석 규칙 마법사 - 템플릿에서 새 규칙 만들기** 블레이드의 **일반** 탭에서 기본 설정을 수락하고 **다음:**을 클릭합니다.** 규칙 논리 설정 >**.

1. **분석 규칙 마법사 - 템플릿에서 새 규칙 만들기** 블레이드의 **규칙 논리 설정** 탭에서 기본 설정을 수락하고 **다음:**을 클릭합니다.** 인시던트 설정 >**.

1. **분석 규칙 마법사 - 템플릿에서 새 규칙 만들기** 블레이드의 **인시던트 설정** 탭에서 기본 설정을 수락하고 **다음: 자동 응답 >** 을 클릭합니다. 

    >**참고**: 여기서 논리 앱으로 구현된 플레이북을 규칙에 추가하여 문제를 자동으로 수정할 수 있습니다.

1. **분석 규칙 마법사 - 템플릿에서 새 규칙 만들기** 블레이드의 **자동 응답** 탭에서 기본 설정을 수락하고 **다음: 검토 >**. 

1. **분석 규칙 마법사 - 템플릿에서 새 규칙 만들기** 블레이드의 **검토 및 만들기** 탭에서 **만들기**를 클릭합니다.

    >**참고**: 이제 활성 규칙이 만들어졌습니다.

#### 작업 4: 플레이북 만들기

이 작업에서는 플레이북을 만듭니다. 보안 플레이북은 Azure Sentinel에서 경고에 대한 대응으로 호출할 수 있는 작업 모음입니다. 

1. Azure Portal 페이지 위쪽의 **리소스, 서비스 및 문서 검색** 텍스트 상자에 **사용자 지정 템플릿 배포**를 입력하고 **Enter**키를 누릅니다.

1. **사용자 지정 배포** 블레이드에서 **편집기에서 사용자 고유의 탬플릿을 빌드합니다.** 옵션을 클릭합니다.

1. **템플릿 편집** 블레이드에서 **로드 파일**을 클릭하고 **\\Allfiles\\Labs\\15\\changeincidentseverity.json** 파일을 찾아 **열기**를 클릭합니다.

    >**참고**: [https://github.com/Azure/Azure-Sentinel/tree/master/Playbooks](https://github.com/Azure/Azure-Sentinel/tree/master/Playbooks)에서 샘플 플레이북을 찾을 수 있습니다.

1. **템플릿 편집** 블레이드에서 **저장**을 클릭합니다.

1. **사용자 지정 배포** 블레이드에서 다음 설정이 구성되었는지 확인합니다 (다른 설정은 기본값으로 유지).

    |설정|값|
    |---|---|
    |구독|이 랩에서 사용 중인 Azure 구독의 이름|
    |리소스 그룹|**AZ500LAB131415**|
    |위치|**(미국) 미국 동부**|
    |플레이북 이름|**Change-Incident-Severity**|
    |사용자 이름|사용자 이메일 주소|

1. **검토 + 만들기**를 클릭한 다음, **만들기**를 클릭합니다.

    >**참고**: 배포가 완료될 때까지 기다립니다.

1. Azure Portal 페이지 위쪽의 **리소스, 서비스 및 문서 검색** 텍스트 상자에 **리소스 그룹**을 입력하고 **Enter**키를 누릅니다.

1. **리소스 그룹** 블레이드의 리소스 그룹 목록에서 **AZ500LAB131415** 항목을 클릭합니다.

1. **AZ500LAB131415** 리소스 그룹 블레이드의 리소스 목록에서 새로 만들어진 **변경-인시던트-심각도** 논리 앱을 나타내는 항목을 클릭합니다.

1. **변경-인시던트-심각도** 블레이드에서 **편집**을 클릭합니다.

    >**참고**: **논리 앱 디자이너** 블레이드에서는 네 개의 연결 각각에 경고가 표시됩니다. 즉, 각각의 연결을 검토하고 구성해야 합니다.

1. **논리 앱 디자이너** 블레이드에서 첫번째 **연결** 단계를 클릭합니다.

1. **새로 추가**를 클릭하고 **테넌트** 드롭다운 목록의 항목에 사용자의 Azure AD 테넌트 이름이 포함되어 있는지 확인하고 **로그인**을 클릭합니다.

1. 메시지가 표시되면 이 랩에서 사용하고 있는 Azure 구독에 대한 Owner 또는 Contributor 역할이 포함된 사용자 계정을 사용하여 로그인합니다.

1. 두 번째 **연결** 단계를 클릭하고, 이전 단계에서 만든 연결을 나타내는 두 번째 항목을 연결 목록에서 선택합니다.

1. 나머지 두 **연결** 단계에 대해 이전 단계를 반복합니다.

    >**참고**: 모든 단계에 경고가 표시되지 않는지 확인합니다.

1. **Logic Apps 디자이너** 블레이드에서 **저장**을 클릭하여 변경 사항을 저장합니다.

#### 작업 5 사용자 지정 경고 만들기 및 플레이북 자동 응답으로 구성

1. Azure Portal에서 **Azure Sentinel \| 개요** 블레이드로 다시 이동합니다.

1. **Azure Sentinel \| 개요** 블레이드의 **구성** 섹션에서 **분석**을 클릭합니다.

1. **Azure Sentinel \| 분석** 블레이드에서 **+ 만들기**를 클릭하고 드롭다운 메뉴에서 **예약된 쿼리 규칙**을 클릭합니다. 

1. **분석 규칙 마법사 - 새 규칙 만들기** 블레이드의 **일반** 탭에서 다음의 설정을 지정합니다(나머지 값은 기본값으로 남겨 둡니다).

    |설정|값|
    |---|---|
    |이름|**플레이북 데모**|
    |전술|**초기 액세스**|

1. **다음: 규칙 논리 설정 >**.

1. **분석 규칙 마법사 - 새 규칙 만들기** 블레이드의 **규칙 논리 설정** 탭의 **규칙 쿼리** 텍스트 상자에서 다음의 규칙 쿼리를 붙여넣기합니다. 

    ```
    AzureActivity
     | where ResourceProviderValue =~ "Microsoft.Security" 
     | where OperationNameValue =~ "Microsoft.Security/locations/jitNetworkAccessPolicies/delete" 
    ```

    >**참고**: 이 규칙은 Just-In-Time VM 액세스 정책의 제거를 식별합니다.

    >**참고** 구문 분석 오류가 표시된 경우 IntelliSense가 쿼리에 값을 추가했을 수 있습니다. 쿼리가 일치하는지 확인하고 그렇지 않으면 쿼리를 메모장에 붙여넣은 다음 메모장에서 규칙 쿼리로 붙여넣습니다. 


1. **분석 규칙 마법사 - 새 규칙 만들기** 블레이드의 **규칙 논리 설정** 탭의 **쿼리 예약**에서 **5분**마다 **쿼리 실행**을 설정합니다.

1. **분석 규칙 마법사 - 새 규칙 만들기** 블레이드의 **규칙 논리 설정** 탭에서 나머지 설정의 기본값을 수락하고 **다음:**을 클릭** 인시던트 설정 >**.

1. **분석 규칙 마법사 - 새 규칙 만들기**블레이드의 **인시던트 설정** 탭에서 기본 설정을 수락하고 **다음:** 을 클릭합니다**자동 응답 >** 을 클릭합니다. 

1. **분석 규칙 마법사 - 새 규칙 만들기** 블레이드의 **자동 응답** 탭에 있는 **경로 자동화** 드롭다운 목록에서 **Change-Incident-Severity** 항목 옆의 체크박스를 선택하고 **다음:**** 검토 >**. 

1. **분석 규칙 마법사 - 새 규칙 만들기** 블레이드의 **검토 및 만들기** 탭에서 **만들기**를 클릭합니다.

    >**참고**: 이제 **플레이북 데모**라는 새로운 활성 규칙이 만들어졌습니다. 규칙 논리로 식별된 이벤트가 발생하면 중간 심각도 경고가 발생하여 해당 인시던트를 생성합니다.

#### 작업 6: 인시던트를 호출하고 관련 작업을 검토합니다.

1. Azure Portal에서 **Security Center \| 개요** 블레이드로 이동합니다.

    >**참고**: 보안 점수를 확인합니다. 지금쯤이면 업데이트되어 있어야 합니다. 

1. **Security Center \| Azure Defender** 블레이드에서 **Just-In-Time VM 액세스** 섹션을 클릭합니다.

1. **Security Center \| Just-In-Time VM 액세스** 블레이드의, **myVM** 가상 머신을 나타내는 행의 오른쪽에서 **생략 부호** 단추를 클릭하고 **제거**를 클릭한 다음 **예**를 클릭합니다.

1. Azure Portal에서 페이지 상단에 있는 **리소르, 서비스 및 문서 검색** 텍스트 상자에서 **활동 로그**를 입력하고 **Enter** 키를 누릅니다.

1. **활동 로그** 블레이드로 이동하고 **JIT 네트워크 액세스 정책 삭제** 항목을 메모합니다. 

    >**참고**: 이 작업은 표시되기까지 1분이 소요될 수 있습니다. 

1. Azure Portal에서 **Azure Sentinel \| 개요** 블레이드로 다시 이동합니다.

1. **Azure Sentinel \| 개요** 블레이드에서 대시보드를 검토하고 Just-In-Time VM 액세스 정책의 삭제에 대응하는 경고가 표시되는지 확인합니다.

    >**참고**: **Azure Sentinel \| 개요** 블레이드에 경고가 표시되려면 최대 5분이 걸릴 수 있습니다. 해당 시점에 경고가 표시되지 않는 경우 이전 작업에서 참조된 쿼리 규칙을 실행하여 Just-In-Time 액세스 정책 삭제 활동이 Azure Sentinel 인스턴스와 연결된 Log Analytics 작업 영역에 전파되었는지 확인합니다. 그렇지 않은 경우 Just-In-Ttime VM 액세스 정책을 다시 만들고 다시 삭제합니다.

1. **Azure Sentinel \| 개요** 블레이드의 **위협 관리** 섹션에서 **인시던트**를 클릭합니다.

1. 블레이드에 중간 또는 높은 심각도 수준의 인시던트가 표시되었는지 확인합니다.

    >**참고**: 인시던트가 **Azure Sentinel \| 인시던트** 블레이드에 표시될 때까지는 최대 5분이 걸릴 수 있습니다. 

    >**참고**: **Azure Sentinel \| 플레이북** 블레이드를 검토하세요. 이 블레이드에서 성공한 실행과 실패한 실행의 횟수를 확인할 수 있습니다.

    >**참고**: 인시던트에 다른 심각도 수준 및 상태를 할당할 수 있는 옵션이 있습니다.

> 결과: Azure Sentinel 작업 영역을 만들고 Azure Activity 로그에 연결하고, Just-In-Time VM 액세스 정책의 삭제에 대한 응답으로 트리거되는 사용자 지정 경고 및 플레이북을 만들고 구성이 유효한지 확인했습니다.

**리소스 정리**

> 더 이상 사용하지 않는 새로 만든 Azure 리소스를 제거해야 합니다. 사용하지 않는 리소스를 제거하면 예기치 않은 비용이 발생하지 않습니다. 

1. Azure Portal 오른쪽 위의 첫 번째 아이콘을 클릭하여 Cloud Shell을 엽니다. 메시지가 표시되면 **PowerShell**, 그리고 **스토리지 만들기**를 클릭합니다.

1. Cloud Shell 창의 왼쪽 위 모서리에 있는 드롭다운 메뉴에서 **PowerShell**이 선택되었는지 확인합니다.

1. Cloud Shell 창 내의 PowerShell 세션에서 다음을 실행하여 이 랩에서 만든 리소스 그룹을 제거합니다.
  
    ```powershell
    Remove-AzResourceGroup -Name "AZ500LAB131415" -Force -AsJob
    ```
1. **Cloud Shell** 창을 닫습니다.
